name: Auto Merge Valid PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

# 关键修复：显式声明所需权限（必须放在顶层！）
permissions:
  pull-requests: write  # 允许批准和合并PR
  contents: read        # 仅读取代码（安全最小权限）

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Emergency stop check
        run: |
          if [ "${{ vars.EMERGENCY_STOP || 'false' }}" == "true" ]; then
            echo "EMERGENCY STOP MODE ACTIVATED! Check repository announcement"
            exit 1
          fi

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          sparse-checkout: |
            notes/

      - name: Validate PR content
        id: validator
        run: |
          USER_LOGIN="${{ github.actor }}"
          PR_HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          echo "Validating PR from @$USER_LOGIN"
          echo "Branch name: $PR_HEAD_REF"
          
          # Rule 1: Branch name must match username
          if [ "$PR_HEAD_REF" != "$USER_LOGIN" ]; then
            echo "::error::BRANCH NAME ERROR! Must be named '$USER_LOGIN' (current: '$PR_HEAD_REF')"
            exit 1
          fi
          
          # Rule 2: Check note file
          NOTE_FILE="notes/${USER_LOGIN}.md"
          if [ ! -f "$NOTE_FILE" ]; then
            NOTE_FILE="notes/${USER_LOGIN}.txt"
            if [ ! -f "$NOTE_FILE" ]; then
              echo "::error::NOTE FILE NOT FOUND! Must create 'notes/${USER_LOGIN}.md' or '.txt'"
              exit 1
            fi
          fi
          
          # Rule 3: Check file content
          if [ ! -s "$NOTE_FILE" ]; then
            echo "::error::NOTE FILE CANNOT BE EMPTY!"
            exit 1
          fi
          
          LINE_COUNT=$(wc -l < "$NOTE_FILE")
          echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
          if [ "$LINE_COUNT" -lt 3 ]; then
            echo "::error::INSUFFICIENT CONTENT! Note file requires at least 3 lines (current: $LINE_COUNT lines)"
            exit 1
          fi
          
          # Rule 4: Check for unauthorized file changes
          git diff --quiet ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- . ':!notes/'
          if [ $? -ne 0 ]; then
            echo "::error::MODIFICATION VIOLATION! Only changes in notes/ directory allowed"
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- . ':!notes/' | while read file; do
              echo "  -> Modified: $file"
            done
            exit 1
          fi
          
          echo "VALIDATION PASSED! Note file: $NOTE_FILE ($LINE_COUNT lines)"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Auto approve and merge (fixed version)
        if: steps.validator.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          # Critical fix 2: Use correct API path
          script: |
            // 1. Approve PR - Use correct API path
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: `AUTO VALIDATION PASSED!\n- Branch: \`${context.payload.pull_request.head.ref}\`\n- File: \`${context.payload.pull_request.user.login}.md\`\n- Lines: ${steps.validator.outputs.line_count}\n\nMerging automatically...`
            });
            
            console.log('PR APPROVED');
            
            // 2. Merge PR - Use correct API path
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Add note: ${context.payload.pull_request.user.login}`,
              commit_message: `Auto-validated contribution from @${context.actor}`
            });
            
            console.log('PR SUCCESSFULLY MERGED TO MAIN BRANCH!');
